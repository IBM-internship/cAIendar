@{
    ViewData["Title"] = "AI Календар";
}

<div class="container mt-5">

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'bg', // Bulgarian locale example
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true,
            events:{
                url: '/Calendar/All',
                method: 'GET',
                extraParams: {},
                failure: function () {
                    alert('There was an error while fetching events!');},
                credentials: 'include'}, // ← this is important!'/Calendar/All', // Endpoint for fetching events
            select: function (info) {
                const start = encodeURIComponent(info.startStr);
                const end = encodeURIComponent(info.endStr);

                // Redirect to the Create Event page with the selected range
                window.location.href = `/Events/Create?start=${start}&end=${end}`;
            },

            eventClick: function (info) {
                alert("Clicked event: " + info.event.title);
            }
        });

        calendar.render();
    });
</script>

@*

<!-- Modal for Creating New Event -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="eventForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Създай събитие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="start" />
                    <input type="hidden" id="end" />
                    <div class="mb-3">
                        <label for="title" class="form-label">Заглавие</label>
                        <input type="text" class="form-control" id="title" required />
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Описание</label>
                        <textarea class="form-control" id="description"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isAllDay" />
                        <label class="form-check-label" for="isAllDay">Целодневно</label>
                    </div>
                    <!-- Add more fields as needed (Color, Location, etc.) -->
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Създай</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="eventForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Ново събитие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Заглавие</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventStart" class="form-label">Начален час</label>
                        <input type="datetime-local" class="form-control" id="eventStart" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventEnd" class="form-label">Краен час</label>
                        <input type="datetime-local" class="form-control" id="eventEnd" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="eventAllDay">
                        <label class="form-check-label" for="eventAllDay">Цял ден</label>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Място</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventMeetingLink" class="form-label">Линк към срещата</label>
                        <input type="url" class="form-control" id="eventMeetingLink">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="eventIsInPerson">
                        <label class="form-check-label" for="eventIsInPerson">Лично присъствие</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                    <button type="submit" class="btn btn-primary">Запази</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #calendar {
        max-width: 100%;
    }

    .fc .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .fc-daygrid-day-number {
        font-weight: 500;
        color: #0d6efd; /* Bootstrap primary */
    }

    .fc-daygrid-day-frame {
        padding: 6px;
    }

    .fc-theme-standard .fc-scrollgrid {
        border: 1px solid #dee2e6; /* Bootstrap border color */
    }

    .fc .fc-button-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

        .fc .fc-button-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
</style>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
        document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'bg',
            selectable: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/api/calendarapi/all'
            // you can keep select if you want, but now it won't prompt
        });

        calendar.render();

        // Bootstrap modal instance
        const eventModalEl = document.getElementById('eventModal');
        const eventModal = new bootstrap.Modal(eventModalEl);

        // Show modal on button click
        document.getElementById('addEventBtn').addEventListener('click', () => {
            // Clear previous values
            document.getElementById('eventForm').reset();
            eventModal.show();
        });

        // Handle form submit
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newEvent = {
                Title: document.getElementById('eventTitle').value.trim(),
                Description: document.getElementById('eventDescription').value.trim(),
                Start: new Date(document.getElementById('eventStart').value).toISOString(),
                End: new Date(document.getElementById('eventEnd').value).toISOString(),
                IsAllDay: document.getElementById('eventAllDay').checked,
                Location: document.getElementById('eventLocation').value.trim(),
                MeetingLink: document.getElementById('eventMeetingLink').value.trim(),
                IsInPerson: document.getElementById('eventIsInPerson').checked
            };

            try {
                const response = await fetch('/api/calendarapi/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newEvent)
                });

                if (response.ok) {
                    const id = await response.json();

                    calendar.addEvent({
                        id: id,
                        ...newEvent
                    });

                    eventModal.hide();
                } else {
                    alert('Грешка при създаване на събитието.');
                }
            } catch (error) {
                console.error('Грешка при заявката:', error);
                alert('Възникна грешка.');
            }
        });
    });

</script>

